---
title: "Case study 2"
output:
  html_notebook: default
  html_document: default
---

In this case study, we will calculate each individual's BMI from their weight and height measurements at three timepoints, at birth and at two exam days where the children are about 2 and 9 years of age.

We need one more package for this case study, which we will install.

```{r}
install.packages("Rmisc")  # For the "multiplot" function.
```

And then we load some packages we will need.

```{r}
library(readxl)  # Reading Excel files.
library(tibble)  # The "tibble" datastructure.
library(dplyr)  # Working with the tibble datastructure.
library(ggplot2)  # Plotting.
library(Rmisc)  # For the "multiplot" function.
library(magrittr)  # Need this for the %>% operator.
library(devtools)  # For printing the session info at the end of the notebook.
```

# Read and pre-process data

We load the Excel file into a tibble, just as in the previous case study, rename the columns, and subset the columns. This time, we need all three measurements of both height and weight.

```{r}
# Read data from Excel file.
data = read_xlsx("weight_height_data.xlsx")

# Rename columns.
data = data %>% rename("ID" = "Identification number", "birth" = "Date of birth", "gender" = "Gender",
              "w0" = "Weight_birth", "h0" = "Height_birth", "exam1" = "Exam_day1", "h1" = "Height_1",
              "w1" = "Weight_1", "exam2" = "Exam_day2", "h2" = "Height_2", "w2" = "Weight_2")

# Subset columns in data.
data = data %>% select("w0", "h0", "w1", "h1", "w2", "h2")

# Print a few rows.
head(data)
```


Note that the birth weight is in grams, while the other weight measurements are in kilograms, so we will convert the birth weight. We do this using the `mutate()` function, calculating the new vaue `w0 / 1000` and storing it in the `w0` variable, thereby replacing the original values in the `w0` variable.

We also convert the height measures to meters, because we want to compute BMI which unit is $kg/m^2$.

```{r}
# Convert birth weight from grams to kilograms, to match the other weight units.
data = data %>% mutate(w0=w0/1000)
# Convert height measures to meters.
data = data %>% mutate(h0=h0/100)
data = data %>% mutate(h1=h1/100)
data = data %>% mutate(h2=h2/100)
```

Next, let's compute the BMI of the children at birth, and at exam days 1 and 2, defined as $BMI = \frac{weight}{height^2}$. We do this again using the `mutate()` function, and this time we create new columns `bmi0`, `bmi1` and `bmi2` and store our calculations in these columns.

```{r}
# Compute BMI at birth and at exam days 1 and 2, and add columns to data.
data = data %>% mutate(bmi0=w0/h0^2,
                       bmi1=w1/h1^2,
                       bmi2=w2/h2^2)
head(data)
```

# Exploratory data analysis

Let's try making box plots of the BMI variables and inspect their distributions.

As usual, we igonre NA values with `na.rm=TRUE`, but this time we want to count the number of NA values and include this number in some plot text. We count the NAs by "pulling" the `bmi0` variable from the data, checking which observations have are NA, and summing these up. Alternatively, we could have done this using the `summarize()` function.

```{r}
# Count NAs in bmi0.
na_count0 = data %>% pull(bmi0) %>% is.na() %>% sum()
```

To include the NA count in the plot text, we use the `sprintf()` fuction. In the example below, we use it to add a string/character to a text using the `'%s'` format, and add an integer to the text using the `'%d'` format.

```{r}
sprintf('A string: %s and an integer: %d', 'a', 1)
```

Note that usually, in the context of a box plot, `ggplot` will group the observations by the `x` variable (in `aes()`), so that we get multiple box plots, but we don't want that right now.

We use the `labs()` function to decide the x and y labels, the title and the subtitle.

Ok, let's put everything together.

```{r fig.width=5, fig.height=5}
ggplot(data, aes(x='', bmi0)) +
  geom_boxplot(na.rm=TRUE) +
  labs(x='', y='BMI', title='BMI at birth', subtitle=sprintf('NA count: %d', na_count0))
```


```{r fig.width=5, fig.height=5}
# Count NAs in bmi1.
na_count0 = data %>% pull(bmi1) %>% is.na() %>% sum()
ggplot(data, aes(x='', bmi1)) +
  geom_boxplot(na.rm=TRUE) +
  labs(x='', y='BMI', title='BMI at exam day 1', subtitle=sprintf('NA count: %d', na_count0))
```

```{r fig.width=5, fig.height=5}
# Count NAs in bmi2.
na_count0 = data %>% pull(bmi2) %>% is.na() %>% sum()
ggplot(data, aes(x='', bmi2)) +
  geom_boxplot(na.rm=TRUE) +
  labs(x='', y='BMI', title='BMI at exam day 2', subtitle=sprintf('NA count: %d', na_count0))
```

As in the previous case study, we see some potential outliers. However, we don't have a good rationale for removing these observations, as we did in before, because we haven't looked at the raw data. So we will refrain from pre-processing the data further.

It would be a good idea at this point to make both histograms and QQ-plots of our data, but we will skip that. We will also skip the scatterplots.


# Modelling

Like in the previous case study, we will fit a linear regression model to our data, this time with `bmi1` as the response and `bmi0` as the explanatory variable. We print a summary of the model and calculate a 95% confidence interval.

```{r}
model1 = lm(bmi1 ~ bmi0, data=data)
summary(model1)
```

```{r}
# Compute 95% confidence interval of the "bmi0" coefficient.
confint(model1, "bmi0", 0.95)
```

The last thing we want to do befor we wrap this case study up is do a little bit of model inspection by plotting the residuals. We assume that the error is normally distributed with zero mean, $\epsilon \in N(0, \sigma_{\epsilon})$. If this turns out to not be the case, then the model is a poor fit on the data, regardless of how impressive our p-values are.

First of all, let's check what the mean of the residuals is. Turns out it's very close to zero, but has a high variance.

```{r}
residuals = model1$residuals
summary(residuals, digits=22)
```

Because we can't see the significant digits in the `summary()` output above, let's calculate the mean again.

```{r}
mean(residuals)
```

Below, we plot the residuals with a boxplot, a qq-plot and a histogram. The data is so obscured by the outliers that it is difficult to say whether it is reasonable to accept them as normally distributed. Therefore, we will try to deal with these outliers in our next case study.

Of course, we could do a similar analysis for BMI at the second exam day, at age of about 9, but we will refrain from going through the same process one more time.


```{r fig.width=10, fig.height=5}
temp = tibble(residuals=residuals)
p1 = ggplot(temp, aes(x='', residuals)) +
  geom_boxplot(na.rm=TRUE) +
  labs(tag='A', x='', y='Residuals', title='Box plot')
p2 = ggplot(temp, aes(sample=residuals)) +
  stat_qq(na.rm=TRUE) + stat_qq_line(na.rm=TRUE) +
  labs(tag='B', x='theoretical', y='sample', title='QQ-plot')
p3 = ggplot(temp, aes(residuals)) +
  geom_histogram(na.rm=TRUE, bins=10) +
  labs(tag='C', x='Residuals', y='Count', title='Histogram')
multiplot(p1, p2, p3, cols=3)
```

```{r}
devtools::session_info()
```
















