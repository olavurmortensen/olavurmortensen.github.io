---
title: "Case study 3"
output:
  html_notebook: default
  html_document: default
---

We will continue with the child weight and height dataset, and this time we will analyse the raw data more closely and see if we can remove some problematic outliers. We will also be using another package from tidyverse, called `lubridate` to work with the dates in the data.

```{r}
library(readxl)  # Reading Excel files.
library(tibble)  # The "tibble" datastructure.
library(dplyr)  # Working with the tibble datastructure.
library(ggplot2)  # Plotting.
library(lubridate)  # Working with datetime objects.
library(magrittr)  # Need this for the %>% operator.
library(devtools)  # For printing the session info at the end of the notebook.
source("multiplot.R")  # For the "multiplot" function.
```

# Read and pre-process data

We load the Excel file into a tibble, just as in the previous case study, and rename the columns. This time we need all columns except ID and gender, so we will refrain from subsetting. We also do the same transformations to the data as in the previous case study.

```{r}
# Read data from Excel file.
data = read_xlsx("weight_height_data.xlsx")

# Rename columns.
data = data %>% rename("ID" = "Identification number", "birth" = "Date of birth", "gender" = "Gender",
              "w0" = "Weight_birth", "h0" = "Height_birth", "exam1" = "Exam_day1", "h1" = "Height_1",
              "w1" = "Weight_1", "exam2" = "Exam_day2", "h2" = "Height_2", "w2" = "Weight_2")

# Convert birth weight from grams to kilograms, to match the other weight units.
data = data %>% mutate(w0=w0/1000)
# Convert height measures to meters.
data = data %>% mutate(h0=h0/100)
data = data %>% mutate(h1=h1/100)
data = data %>% mutate(h2=h2/100)
# Compute BMI at birth and at exam days 1 and 2, and add columns to data.
data = data %>% mutate(bmi0=w0/h0^2,
                       bmi1=w1/h1^2,
                       bmi2=w2/h2^2)
```

We want to know the ages of the children at exam day 1 and 2. Unfortunately, working with dates can be a hassle, because of irregular formatted dates, and not completely straight-forward math in computing the time differences. Luckily, the `lubridate` package makes things (relatively) easy for us.

First, let's convert all the dates to the same format using the `ymd()` ("year-month-day") and `dmy()` ("day-month-year") functions from `lubridate`. Just to check the the *data type* for these reformatted dates, we pull one of the columns and use the `class()` function.

```{r}
# Convert all dates to lubridate's "Date" objects.
data = data %>% mutate(birth=ymd(birth))
data = data %>% mutate(exam1=dmy(exam1))
data = data %>% mutate(exam2=dmy(exam2))
# We show what the data type is for the dates.
class(data %>% pull(birth))
```

Now we want to compute new variables in the data representing the ages. To compute the age, we use the `interval()` function, convert the interval to a "duration" (in the lingo of `lubridate`), and then convert that into a numeric value representing years as a floating point number.

```{r}
# Convert to an "interval" object, then to a "duration" object, and finally to a numeric value representing the number of years as a floating point.
data = data %>% mutate(age1=interval(birth, exam1) %>%
                  as.duration(.) %>%
                  as.numeric(., "years"))
# Do the same for exam day 2.
data = data %>% mutate(age2=interval(birth, exam2) %>%
                  as.duration(.) %>%
                  as.numeric(., "years"))
```

We won't be using the dates anymore, now that we have calculated the ages of the children, so we will remove those columns. We use the `select()` function, as usual, but this time we supply a list of columns we want to remove, rather than the ones we want to keep, and use the minus sign (`-`) in front of the list to invert this selection operation.

```{r}
# Remove some columns from the data that we no longer need (note the minus sign
# in front of the list).
data = data %>% select(-c('birth', 'exam1', 'exam2'))
```


# Exploratory data analysis

Let's plot the distribution of some of our variables. Below we make a box plot and a histogram of our age variables. There is one very obvious outlier in the second exam day, where one child is three years old. We will definitely remove this outlier, as it doesn't make sense for this experiment. Besides this outlier, the children are quite close in age. Note that we don't have an assumption that these variables are normally distributed.

```{r fig.width=10, fig.height=8}
p1 = ggplot(data, aes(x='', age1)) +
  geom_boxplot(na.rm=TRUE) +
  labs(tag='A', x='', y='Age (years)', title='Box plot of age at exam day 1')
p2 = ggplot(data, aes(age1)) +
  geom_histogram(na.rm=TRUE, bins=10) +
  labs(tag='B', title='Histogram of age at exam day 1', x='Age (years)', y='Count')
p3 = ggplot(data, aes(x='', age2)) +
  geom_boxplot(na.rm=TRUE) +
  labs(tag='C', x='', y='Age (years)', title='Box plot of age at exam day 2')
p4 = ggplot(data, aes(age2)) +
  geom_histogram(na.rm=TRUE, bins=10) +
  labs(tag='D', title='Histogram of age at exam day 2', x='Age (years)', y='Count')
multiplot(p1, p3, p2, p4, cols=2)
```

Similarly, we plot the distribution of the weight and the height variables below. Of course, we see the same outlier with the birth height of about 1 meter, which we will remove. Although we see some other outliers we don't have any rationale for removing them.

```{r fig.width=10, fig.height=8}
p1 = ggplot(data, aes(x='', w0)) +
  geom_boxplot(na.rm=TRUE) +
  labs(tag='A', x='', y='Weight (kg)', title='Box plot of weight at birth')
p2 = ggplot(data, aes(w0)) +
  geom_histogram(na.rm=TRUE, bins=10) +
  labs(tag='B', title='Histogram of weight at birth', x='Weight (kg)', y='Count')
p3 = ggplot(data, aes(x='', w1)) +
  geom_boxplot(na.rm=TRUE) +
  labs(tag='C', x='', y='Weight (kg)', title='Box plot of weight at exam day 1')
p4 = ggplot(data, aes(w1)) +
  geom_histogram(na.rm=TRUE, bins=10) +
  labs(tag='D', title='Histogram of weight at exam day 1', x='Weight (kg)', y='Count')
p5 = ggplot(data, aes(x='', w2)) +
  geom_boxplot(na.rm=TRUE) +
  labs(tag='E', x='', y='Weight (kg)', title='Box plot of weight at exam day 2')
p6 = ggplot(data, aes(w2)) +
  geom_histogram(na.rm=TRUE, bins=10) +
  labs(tag='F', title='Histogram of weight at exam day 2', x='Weight (kg)', y='Count')
multiplot(p1, p3, p5, p2, p4, p6, cols=2)
```


```{r fig.width=10, fig.height=8}
p1 = ggplot(data, aes(x='', h0)) +
  geom_boxplot(na.rm=TRUE) +
  labs(tag='A', x='', y='Height (m)', title='Box plot of height at birth')
p2 = ggplot(data, aes(h0)) +
  geom_histogram(na.rm=TRUE, bins=10) +
  labs(tag='B', title='Histogram of height at birth', x='Height (m)', y='Count')
p3 = ggplot(data, aes(x='', h1)) +
  geom_boxplot(na.rm=TRUE) +
  labs(tag='C', x='', y='Height (m)', title='Box plot of height at exam day 1')
p4 = ggplot(data, aes(h1)) +
  geom_histogram(na.rm=TRUE, bins=10) +
  labs(tag='D', title='Histogram of height at exam day 1', x='height (kg)', y='Count')
p5 = ggplot(data, aes(x='', h2)) +
  geom_boxplot(na.rm=TRUE) +
  labs(tag='E', x='', y='Height (m)', title='Box plot of height at exam day 2')
p6 = ggplot(data, aes(h2)) +
  geom_histogram(na.rm=TRUE, bins=10) +
  labs(tag='F', title='Histogram of height at exam day 2', x='Height (m)', y='Count')
multiplot(p1, p3, p5, p2, p4, p6, cols=2)
```

As we see below, when we filter the data we only remove two outliers, based on criteria discussed above.

```{r}
# Number of observation before filter.
n_before = dim(data)[1]
# Remove outliers.
data = data %>% filter(age2 > 4 | is.na(age2)) %>%
  filter(h0 < 0.9 | is.na(h0))
# Number of observations after filter.
n_after = dim(data)[1]
# Print difference.
print(n_before - n_after)
```



```{r fig.width=10, fig.height=8}
p1 = ggplot(data, aes(x='', bmi0)) +
  geom_boxplot(na.rm=TRUE) +
  labs(tag='A', x='', y='BMI', title='Box plot of BMI at birth')
p2 = ggplot(data, aes(bmi0)) +
  geom_histogram(na.rm=TRUE, bins=10) +
  labs(tag='B', title='Histogram of BMI at birth', x='BMI', y='Count')
p3 = ggplot(data, aes(sample=bmi0)) +
  stat_qq(na.rm=TRUE) + stat_qq_line(na.rm=TRUE) +
  labs(tag='C', title='QQ-plot of BMI at birth')

p4 = ggplot(data, aes(x='', bmi1)) +
  geom_boxplot(na.rm=TRUE) +
  labs(tag='D', x='', y='BMI', title='Box plot of BMI at exam day 1')
p5 = ggplot(data, aes(bmi1)) +
  geom_histogram(na.rm=TRUE, bins=10) +
  labs(tag='E', title='Histogram of BMI at exam day 1', x='BMI', y='Count')
p6 = ggplot(data, aes(sample=bmi1)) +
  stat_qq(na.rm=TRUE) + stat_qq_line(na.rm=TRUE) +
  labs(tag='F', title='QQ-plot of BMI at exam day 1')

p7 = ggplot(data, aes(x='', bmi2)) +
  geom_boxplot(na.rm=TRUE) +
  labs(tag='G', x='', y='BMI', title='Box plot of BMI at exam day 2')
p8 = ggplot(data, aes(bmi2)) +
  geom_histogram(na.rm=TRUE, bins=10) +
  labs(tag='H', title='Histogram of BMI at exam day 2', x='BMI', y='Count')
p9 = ggplot(data, aes(sample=bmi2)) +
  stat_qq(na.rm=TRUE) + stat_qq_line(na.rm=TRUE) +
  labs(tag='I', title='QQ-plot of BMI at exam day 2')
multiplot(p1, p4, p7, p2, p5, p8, p3, p6, p9, cols=3)
```
